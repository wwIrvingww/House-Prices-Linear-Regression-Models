---
title: "clasification"
author: "Irving, Chuy"
date: "2025-03-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rpart)
library(rpart.plot)
```

```{r load_data, include=FALSE}
train_data <- read_csv("train_final.csv")
test_data <- read.csv("test_final.csv")

```

```{r remove_na_columns, include=FALSE}
porcentaje_na <- sapply(train_data, function(x) sum(is.na(x)) / length(x)) * 100

columnas_a_eliminar <- names(porcentaje_na[porcentaje_na > 75])
print(columnas_a_eliminar)

train_data <- train_data[, !names(train_data) %in% columnas_a_eliminar]
```

## Árbol de clasificación  

Se realiza un árbol de clasificación para saber si una casa tiene un precio barato, medio o caro. Para esto hay que hacer una variable categórica que tenga 3 categorías barato, medio y caro.
```{r discretizando la variable respuesta}
# Usamos tres cortes basados en cuartiles para generar tres categorías
categorias <- cut(train_data$SalePrice, breaks=c(min(train_data$SalePrice),
                                                  quantile(train_data$SalePrice, probs = 1/3),
                                                  quantile(train_data$SalePrice, probs = 2/3),
                                                  max(train_data$SalePrice)),
                  labels=c("barata", "estandar", "cara"), include.lowest=TRUE)

# Asignamos las nuevas categorías al DataFrame
train_data$consumoCat <- categorias

```

Luego de discretizar la variable millas por galon usando los cuartiles quedan las categorías en la siguiente proporpoción. 

## puntos de corte
```{r cortes}
puntos_de_corte <- quantile(train_data$SalePrice, probs = c(0, 1/3, 2/3, 1))

print(puntos_de_corte)

```

```{r variable categrica}
table(train_data$consumoCat)
```
Para clasificar las casas en categorías de "barata", "estándar" y "cara", se han utilizado puntos de corte basados en la distribución de SalePrice. El precio mínimo registrado es $39,300, mientras que el primer cuantil (33.33%) se sitúa en $139,400 y el segundo cuantil (66.66%) en $190,000, alcanzando un máximo de $755,000. Estas cifras permiten definir las categorías: "barata" abarca precios de $39,300 a $139,400, "estándar" de $139,401 a $190,000, y "cara" para precios superiores a $190,001.

La elección de estos límites se fundamenta en la distribución de precios en el mercado inmobiliario, asegurando que cada categoría contenga aproximadamente un tercio de los datos. Esto no solo proporciona equidad en la representación de las diferentes clases, sino que también refleja la sensibilidad al contexto del mercado, lo que hace que las categorías sean relevantes y comprensibles para compradores y vendedores.

Este enfoque permite una segmentación clara y efectiva de los precios, facilitando la toma de decisiones informadas. Al basar las categorías en cuantiles, se garantiza que los análisis posteriores sean estadísticamente relevantes y útiles para todas las partes interesadas, mejorando así la comprensión del mercado inmobiliario.


### Arbol de clasificación
```{r elimianar variable respuesta}
train_data <- train_data %>% select(-SalePrice)
```

```{r arbol graficoecho=FALSE}

tree_model <- rpart(consumoCat ~ ., data = train_data, method = "class")

rpart.plot(tree_model, main="Árbol de Clasificación de Precios de Casas", extra=102)

```
Se observan las divisiones en las categorías previstas anteriormente. Por defecto la primera categoría que utiliza el árbol es *estandar* , es decir que antes de hacer cualquier división basada en las características, el modelo considera que una gran parte de las casas cae en la categoría "estandar" según los datos de entrenamiento. Además, observamos como la variable que mejor crea esta clasificación es `OverallQual`, lo cual solo termina de confirmar el análisis previsto en donde decíamos que esta variable es la que mejor describe el comportamiento de nuestra variable respuesta. Entonces lo primero que vemos en el diagrama es que si el valor de `OverallQual` es menor a 7 entonces la probabilidad de que sea barata es del 62%, pero si es mayor a 7 entonces la probabilidad de que sea cara es del 38%.  
Luego podemos ver como una variable importante es `Neigborhood`, en donde si el barrio es de Blueste, BrDale, BrjSIDE, Edwards, IDOTRR, MeadowV, OldTown, Sawyer, SWISU entonces la probabilidad de que sea barata es del 28%, lo que significa que después de la variable `OverallQual`, una variable importante a considerar es `Neigborhood`. En caso de que  no pertenezca, la probabilidad de que sea estándar es del *35%*, y entonces entra en juego la variable *`GrLivArea`* que es el área habitable por encima del nivel del suelo, en donde si es menor a *1067* existe un *10%* de probabilidad que sea barata y acá vuelve a entrar en juego `OverallQual` y si es menor a 6 entonces la probabilidad de que sea barata es del *8%* y si es mayor a 6 existe una probabilidad del *3%* de que sea cara, pero si el `GrivLivArea`  es mayor a 1067 existe un *24%* de que sea un precio estándar, y si volvemos a verificar su valor y este es menor a 1583 la probabilidad de que sea estándar es del 15%, pero si es mayor a 1583 la probabilidad de que sea estándar es del 9%, acá entra en juego otra variablle llamada *`BsmtFinSF1`* que hace referencia al área determinada del sótano respectivamente, el cual si es menor a 610 existe un probabilidad del 7% de que sea precio estándar, pero si fuera mayor a este valor, entonces existe un 3% de que sea cara.  
Regresando a la partición inicial de `OverallQual`, si este valor fuera mayor 7 la probabilidad de que sea cara es de un *38%* en caso de que el `GrLivArea` sea menor a 1478 y pertenezca y su valor en *Neigborhood* es perteneciente a CollgCr, Edwards, Gilbert, NoRidge NridgHt, OldTown, entonces aumenta a *47%*. En caso de que sea mayor 1478, la probababilidad de que sea cara es de *67%* y acá entra en juego una última variable llamada *`TotalBsmtSF`* que es parecida a `BsmtFinSF1`, pero esta es `TotalBsmtSF`que es el área total del sótano respectivamente, en donde si es menor a 844 la probabilidad de que sea estándar  es de *51%*, pero si es mayor a 844 entonces la probabilidad de que sea cara es del 92%.  
En conclusión, ahora tenemos conocimiento de nuevas variables que juegan un papel importante en el precio de las casas: OverallQual, GrLivArea, Neighborhood, TotalBsmtSF, BsmFinSF1, ordenado en la jerarquía mencionada recién.
